#!/usr/bin/env bash
# Copyright (C) 2024 Patrick Brisbin
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
set -euo pipefail

bucket=sites-docs-bucket-1vleclrg7tli7
prefix=data-files/restylers/manifests
distribution_id=E539B2WJC12CB

if (($# != 1)); then
  echo "Usage: bin/promote <channel>" >&2
  echo "Upload restylers.yaml to s3://.../channel/restylers.yaml" >&2
  exit 64
fi

path=restylers.yaml
channel=$1

if [[ ! -f "$path" ]]; then
  echo "$path: file not found" >&2
  exit 1
fi

aws s3 cp --acl public-read --content-type text/plain "$path" \
  "s3://$bucket/$prefix/$channel/$path"

aws cloudfront create-invalidation \
  --distribution-id "$distribution_id" \
  --paths "/$prefix/$channel/$path"
