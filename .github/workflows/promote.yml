name: Promote

on:
  # Approximate "every 2 weeks" by doing 1st and 15th of the month.
  schedule:
    - cron: "0 07 01 * *"
    - cron: "0 07 15 * *"

  # Run it if touched
  pull_request:
    paths:
      - .github/workflows/promote.yml

  # Or manually trigger
  workflow_dispatch:
    inputs:
      from:
        description: Tag to promote from
        required: true
        default: dev
      to:
        description: Tag to promote to
        required: true
        default: stable

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.aws_access_key_id }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.aws_secret_access_key }}
      AWS_DEFAULT_REGION: us-east-1

    steps:
      - id: prep
        run: |
          case "$GITHUB_EVENT_NAME" in
            'schedule')
              # Promote dev to stable on the schedule
              echo 'from=dev'
              echo 'to=stable'
            ;;
            'pull_request')
              # Promote dev to itself just to test our logic
              echo 'from=dev'
              echo 'to=dev'
            ;;
            'workflow_dispatch')
              # Promote what was given
              echo 'from=${{ github.event.from }}'
              echo 'to=${{ github.event.to }}'
            ;;
            *)
              echo "Unexpected event: $GITHUB_EVENT_NAME" >&2
              exit 1
            ;;
          esac >>"$GITHUB_OUTPUT"
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}

      - uses: restyled-io/actions/setup-demo@v2
        with:
          channel: ${{ steps.prep.outputs.from }}

      - uses: restyled-io/actions/setup@v2
      - uses: restyled-io/actions/run@v2
        with:
          paths: .

      - uses: actions/checkout@v4
        with:
          sparse-checkout: bin/promote
          sparse-checkout-cone-mode: false

      - run: ./bin/promote "${{ steps.prep.outputs.from }}" "${{ steps.prep.outputs.to }}"

      - name: Notify
        if: always()
        uses: zulip/github-actions-zulip/send-message@v1.0.2
        with:
          api-key: ${{ secrets.ZULIP_API_KEY }}
          email: ${{ secrets.ZULIP_EMAIL }}
          organization-url: ${{ secrets.ZULIP_ORGANIZATION_URL }}
          to: 'changelog'
          type: 'stream'
          topic: 'Restylers Releases'
          content: |
            Promotion of `${{ steps.prep.outputs.from }}` to `${{ steps.prep.outputs.to }}`: ${{ job.status }}
